version: "3.5"
services:

  # the setup runs on host-network to allow the iptable manipulation needed for the tests.

  echo-server:
    image: cilium/echoserver
    hostname: echo
    network_mode: host
    environment:
      - PORT=6060

  envoy:
    image: quay.io/wi_stefan/envoy
    hostname: envoy
    # required for writing the intial config and iptable to match
    user: root
    network_mode: host
    entrypoint: ./initial-config/init.sh
    volumes:
      - envoy-config:/etc/envoy
      - ./initial-config:/initial-config

  resource-updater:
    image: quay.io/wi_stefan/envoy-resource-updater
    hostname: update-resources
    network_mode: host
    # required to write at the mounted volumes
    user: root
    volumes:
      - map-folder:/configmap-folder:rw
      - envoy-config:/proxy-config:rw


  config-service:
    image: quay.io/wi_stefan/endpoint-configuration-service
    hostname: config-service
    network_mode: host
    # required to write at the mounted volumes
    user: root
    environment:
      - PROXY_LISTENER_YAML_PATH=/envoy-config/listener.yaml
      - PROXY_CLUSTER_YAML_PATH=/envoy-config/cluster.yaml
      - I_SHARE_CERTIFICATE_FOLDER_PATH=/ishare/certs
      - PROXY_SOCKET_ADDRESS_ADDRESS=0.0.0.0
      - PROXY_EXTERNAL_AUTH_ADDRESS=localhost
      - PROXY_EXTERNAL_AUTH_PORT=7070
      - MICRONAUT_SERVER_PORT=9090
    volumes:
      - map-folder:/envoy-config:rw
      - ishare-certs:/ishare/certs:rw
      
  auth-provider:
    image: quay.io/wi_stefan/ishare-auth-provider 
    hostname: auth-provider
    network_mode: host
    environment:
      - SERVER_PORT=7070
      - CONFIGURATION_SERVICE_URL=http://localhost:9090
      - CERTIFICATE_FOLDER=/go/src/app/certs/
    volumes:
      - ishare-certs:/go/src/app/certs

  ishare-idp-mock:
    image: mockserver/mockserver:mockserver-5.11.2
    hostname: idp-mock
    network_mode: host
    environment: 
      - MOCKSERVER_PROPERTY_FILE=/config/mockserver.properties
    volumes:
      - ./idp-mock:/config


volumes:
  map-folder: ~
  envoy-config: ~
  ishare-certs: ~